<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>즐겨찾기 추가</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container">
    <h2 class="my-3">즐겨찾기 추가</h2>

    <label class="mt-2">이름</label>
    <input type="text" class="form-control" id="nameInput">

    <label class="mt-3">주소</label>
    <!-- URL 입력 + 중복확인 버튼 -->
    <div class="input-group">
        <input type="text" class="form-control" id="urlInput" >
        <button type="button" class="btn btn-info" id="dupBtn">중복확인</button>
    </div>
    <small id="dupMsg" class="d-block mt-1 text-danger"></small>

    <button id="addBtn" type="button" class="btn btn-success w-100 mt-3">추가</button>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
        crossorigin="anonymous"></script>
<script>
$(function () {

    // URL 입력값이 바뀌면 중복 검사 결과 초기화
    $("#urlInput").on("input", function () {
        $(this).data("url-usable", null);
        $("#dupMsg").text("").removeClass("text-success text-danger");
    });

    // 1) 중복확인 버튼 클릭 시
    $("#dupBtn").on("click", function () {
        let url = $("#urlInput").val().trim();

        if (url === "") {
            alert("주소를 입력하세요");
            return;
        }

        $.ajax({
            type: "get",
            url: "/ajax/favorite/duplicate",
            data: {url: url},
            success: function (res) {
                $("#dupMsg")
                    .text(res.message)
                    .toggleClass("text-success", res.usable)
                    .toggleClass("text-danger", !res.usable);

                $("#urlInput").data("url-usable", res.usable);
            },
            error: function () {
                alert("중복 확인 에러!");
            }
        });
    });

    // 2) 추가 버튼 클릭 시
    $("#addBtn").on("click", function () {
        let name = $("#nameInput").val().trim();
        let url  = $("#urlInput").val().trim();
        let usable = $("#urlInput").data("url-usable");

        if (name === "") {
            alert("사이트 이름을 입력하세요");
            return;
        }

        if (url === "") {
            alert("주소를 입력하세요");
            return;
        }

        if (!url.startsWith("http://") && !url.startsWith("https://")) {
            alert("잘못된 규격의 주소입니다.");
            return;
        }

        if (usable === null) {
            alert("중복 확인을 먼저 해주세요.");
            return;
        }

        if (usable === false) {
            alert("중복된 URL입니다.");
            return;
        }

        $.ajax({
            type: "post",
            url: "/ajax/favorite/create",
            data: {name: name, url: url},
            success: function (response) {
                if (response.result === "success") {
                    location.href = "/ajax/favorite/list";
                } else {
                    alert("즐겨찾기 추가 실패!");
                }
            },
            error: function () {
                alert("즐겨찾기 추가 에러!");
            }
        });
    });

});
</script>
</body>
</html>
